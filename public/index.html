<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unconditioning</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }
        canvas {
            display: block;  /* Remove potential scroll bars */
            width: 100%;     /* Ensure canvas takes full window width */
            height: 100%;    /* Ensure canvas takes full window height */
        }
        #overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* Center the text */
            font-size: 36px; /* Font size */
            color: white;
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;  /* Add some padding */
            border-radius: 10px;
            display: none; /* Initially hidden */
            text-align: center; /* Center the text */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #startBtn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            font-size: 18px;
            z-index: 10;
        }
        #location, #instruction {
            margin: 10px 0;
        }
        #backToCamera {
            font-size: 14px; /* Adjust font size */
            margin-top: 20px; /* Add top margin */
            text-align: center;
            position: absolute;
            bottom: 0; /* Place text at the bottom */
            width: 100%;
        }
    </style>
</head>
<body>

<canvas id="canvas"></canvas>
<div id="overlay" onclick="returnToCamera()">
    <div id="location"></div> <!-- Display GPS location -->
    <div id="instruction"></div> <!-- Display instruction text -->
    <div id="backToCamera">Click to return to the camera</div> <!-- Smaller text, placed at the bottom -->
</div>
<button id="startBtn">See the Guidance Sign</button>

<script>
    const video = document.createElement('video');  // Create hidden video element
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    const blockSize = 45;  // Set block size
    const saturationFactor = 7.5;  // Increase saturation factor
    const instructions = [
        "Follow the rules",
        "Why are you listening to me?",
        "Why are you obeying it?",
        "Don't listen to it",
        "Keep walking",
        "Ignore it"
    ];

    let isCameraActive = true; // Determine whether the camera is active
    const overlay = document.getElementById('overlay');
    const startBtn = document.getElementById('startBtn');
    const locationDiv = document.getElementById('location');
    const instructionDiv = document.getElementById('instruction');
    let currentLatitude = '';
    let currentLongitude = '';
    let currentInstruction = '';

    // Get the video stream from the camera
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(function (stream) {
            video.srcObject = stream;
            video.play();

            video.addEventListener('loadedmetadata', function () {
                resizeCanvas();

                function processFrame() {
                    if (isCameraActive) {
                        context.save();  // Save the current canvas state
                        context.scale(-1, 1);  // Flip horizontally
                        context.translate(-canvas.width, 0);  // Translate the canvas back

                        context.drawImage(video, 0, 0, canvas.width, canvas.height);

                        let imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                        let data = imageData.data;

                        context.clearRect(0, 0, canvas.width, canvas.height);

                        for (let y = 0; y < canvas.height; y += blockSize) {
                            for (let x = 0; x < canvas.width; x += blockSize) {
                                let red = 0, green = 0, blue = 0, count = 0;

                                for (let dy = 0; dy < blockSize && y + dy < canvas.height; dy++) {
                                    for (let dx = 0; dx < blockSize && x + dx < canvas.width; dx++) {
                                        let index = ((y + dy) * canvas.width + (x + dx)) * 4;
                                        red += data[index];
                                        green += data[index + 1];
                                        blue += data[index + 2];
                                        count++;
                                    }
                                }

                                red = Math.floor(red / count);
                                green = Math.floor(green / count);
                                blue = Math.floor(blue / count);

                                let gray = (red + green + blue) / 3;
                                red = Math.min(255, Math.max(0, gray + (red - gray) * saturationFactor));
                                green = Math.min(255, Math.max(0, gray + (green - gray) * saturationFactor));
                                blue = Math.min(255, Math.max(0, gray + (blue - gray) * saturationFactor));

                                const radius = blockSize / 2;
                                context.fillStyle = `rgb(${red}, ${green}, ${blue})`;
                                context.beginPath();
                                context.arc(x + radius, y + radius, radius, 0, Math.PI * 2);
                                context.fill();

                                const complementRed = 255 - red;
                                const complementGreen = 255 - green;
                                const complementBlue = 255 - blue;

                                context.fillStyle = `rgb(${complementRed}, ${complementGreen}, ${complementBlue})`;
                                const diamondSize = radius / 1.5;
                                context.beginPath();
                                context.moveTo(x + radius, y + radius - diamondSize);
                                context.lineTo(x + radius + diamondSize, y + radius);
                                context.lineTo(x + radius, y + radius + diamondSize);
                                context.lineTo(x + radius - diamondSize, y + radius);
                                context.closePath();
                                context.fill();
                            }
                        }

                        context.restore();
                    }

                    requestAnimationFrame(processFrame);
                }

                processFrame();
            });
        })
        .catch(function (error) {
            console.error("Unable to access the camera: ", error);
        });

    // Switch to random background and instruction, get GPS coordinates
    startBtn.addEventListener('click', function() {
        isCameraActive = false;

        // Randomly select an instruction
        currentInstruction = instructions[Math.floor(Math.random() * instructions.length)];
        instructionDiv.textContent = currentInstruction;

        // Get and display GPS location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                currentLatitude = position.coords.latitude.toFixed(6);
                currentLongitude = position.coords.longitude.toFixed(6);
                locationDiv.textContent = `Latitude: ${currentLatitude}, Longitude: ${currentLongitude}`;
            }, function(error) {
                locationDiv.textContent = "Unable to get GPS location";
                console.error("Failed to retrieve GPS location:", error);
            });
        } else {
            locationDiv.textContent = "Geolocation not supported by this browser";
        }

        // Show instruction and location
        overlay.style.display = 'block';
        startBtn.style.display = 'none';
        document.body.style.backgroundColor = getRandomColor();
        
        // Save image
        const imageDataUrl = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.href = imageDataUrl;
        link.download = 'screenshot.png';
        link.click();
    });

    // Click to return to the camera page
    function returnToCamera() {
        isCameraActive = true;
        overlay.style.display = 'none';
        startBtn.style.display = 'block';
        document.body.style.backgroundColor = '';  // Reset background
    }

    // Randomly generate background color
    function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // Save image and upload to server
const imageDataUrl = canvas.toDataURL('image/png');
const link = document.createElement('a');
link.href = imageDataUrl;
link.download = 'screenshot.png';
link.click();

// Send screenshot data to the server
fetch('/upload', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        screenshot: imageDataUrl,
        latitude: currentLatitude,
        longitude: currentLongitude,
        instruction: currentInstruction,
        timestamp: new Date().toLocaleString()
    })
})
.then(response => response.json())
.then(data => {
    console.log(data.message);
})
.catch(error => console.error('Error:', error));

</script>

</body>
</html>
